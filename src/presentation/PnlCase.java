package presentation;

import base.RepairDao;
import domaine.Customer;
import domaine.Note;
import java.awt.Component;
import java.sql.Date;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import javax.swing.JButton;
import javax.swing.JFrame;
import javax.swing.text.BadLocationException;

/**
 *
 * @author Thery Ehrlich
 */
public class PnlCase extends javax.swing.JPanel {

    private PnlNewPartsSelection p2;
    private PnlPermaNote p3;
    private Component[] customerComponents;
    private final JFrame parent;
    private final boolean isNewRep;
    private ArrayList<Note> lstNotes;
    private ArrayList statusList = new ArrayList();
    protected PnlPartsUsedSelection p1;
    private int repNo;
    private String customerAdress;
    private String customerArea;
    private int customerNpa;
    SimpleDateFormat sdf = new SimpleDateFormat("dd.MM.yyyy");

    /**
     * Creates new form PnlNewCase
     *
     *
     * @param parent
     * @param isNewRep
     */
    public PnlCase(JFrame parent, boolean isNewRep) {
        this.isNewRep = isNewRep;
        this.parent = parent;
        initComponents();
        btnModifyCust.setEnabled(false);
        btnModifyCust.setVisible(false);
        checkRepStatus(isNewRep);
    }
    
    public PnlCase(JFrame parent, boolean isNewRep, int repNo) {
        this.repNo = repNo;
        this.isNewRep = isNewRep;
        this.parent = parent;
        initComponents();
        btnModifyCust.setEnabled(false);
        btnModifyCust.setVisible(false);
        checkRepStatus(isNewRep);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        pnlGenInfo = new javax.swing.JPanel();
        pnlCustInfo = new javax.swing.JPanel();
        lblCustName = new javax.swing.JLabel();
        lblCustEmail = new javax.swing.JLabel();
        lblCustPhone = new javax.swing.JLabel();
        btnModifyCust = new javax.swing.JButton();
        pnlRepairInfo = new javax.swing.JPanel();
        cboStatus = new javax.swing.JComboBox<>();
        lblRepStatus = new javax.swing.JLabel();
        lblStartDateValue = new javax.swing.JLabel();
        lblStartDate = new javax.swing.JLabel();
        pnlMachineInfo = new javax.swing.JPanel();
        pnlDetails = new javax.swing.JPanel();
        pnlPartsCustomer = new javax.swing.JPanel();
        pnlNotesSct = new javax.swing.JPanel();
        pnlNotesTitleBox = new javax.swing.JPanel();
        lblNotes = new javax.swing.JLabel();
        btnNewNote = new javax.swing.JButton();
        scpNotes = new javax.swing.JScrollPane();
        pnlNotes = new javax.swing.JPanel();
        pnlExtraInfo = new javax.swing.JPanel();
        btnSave = new javax.swing.JButton();
        btnCancel = new javax.swing.JButton();

        setBackground(new java.awt.Color(245, 245, 245));
        setMinimumSize(new java.awt.Dimension(1150, 750));
        setPreferredSize(new java.awt.Dimension(1150, 750));
        setRequestFocusEnabled(false);
        setLayout(new javax.swing.BoxLayout(this, javax.swing.BoxLayout.Y_AXIS));

        pnlGenInfo.setBackground(new java.awt.Color(255, 255, 255));
        pnlGenInfo.setMaximumSize(new java.awt.Dimension(32767, 150));
        pnlGenInfo.setMinimumSize(new java.awt.Dimension(675, 125));
        pnlGenInfo.setPreferredSize(new java.awt.Dimension(675, 125));
        pnlGenInfo.setRequestFocusEnabled(false);
        pnlGenInfo.setLayout(new java.awt.GridLayout(1, 0));

        pnlCustInfo.setBackground(new java.awt.Color(255, 255, 255));
        pnlCustInfo.setMinimumSize(new java.awt.Dimension(387, 185));

        lblCustName.setFont(new java.awt.Font("PingFang HK", 1, 24)); // NOI18N
        lblCustName.setForeground(new java.awt.Color(0, 102, 255));
        lblCustName.setText("Nouveau client");

        lblCustEmail.setFont(new java.awt.Font("PingFang HK", 0, 12)); // NOI18N
        lblCustEmail.setText("Aucune information enregistrée");

        lblCustPhone.setFont(new java.awt.Font("PingFang HK", 0, 12)); // NOI18N
        lblCustPhone.setText(" ");

        btnModifyCust.setBackground(new java.awt.Color(255, 255, 255));
        btnModifyCust.setForeground(new java.awt.Color(51, 51, 255));
        btnModifyCust.setMnemonic('d');
        btnModifyCust.setText("(modifier)");
        btnModifyCust.setToolTipText("");
        btnModifyCust.setAlignmentY(0.0F);
        btnModifyCust.setAutoscrolls(true);
        btnModifyCust.setBorderPainted(false);
        btnModifyCust.setContentAreaFilled(false);
        btnModifyCust.setFocusable(false);
        btnModifyCust.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        btnModifyCust.setHorizontalTextPosition(javax.swing.SwingConstants.LEFT);
        btnModifyCust.setIconTextGap(0);
        btnModifyCust.setInheritsPopupMenu(true);
        btnModifyCust.setMargin(new java.awt.Insets(2, 2, 2, 2));
        btnModifyCust.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnModifyCustActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout pnlCustInfoLayout = new javax.swing.GroupLayout(pnlCustInfo);
        pnlCustInfo.setLayout(pnlCustInfoLayout);
        pnlCustInfoLayout.setHorizontalGroup(
            pnlCustInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlCustInfoLayout.createSequentialGroup()
                .addGap(25, 25, 25)
                .addGroup(pnlCustInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(pnlCustInfoLayout.createSequentialGroup()
                        .addComponent(lblCustName)
                        .addGap(2, 2, 2)
                        .addComponent(btnModifyCust))
                    .addComponent(lblCustEmail)
                    .addComponent(lblCustPhone))
                .addContainerGap(134, Short.MAX_VALUE))
        );
        pnlCustInfoLayout.setVerticalGroup(
            pnlCustInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlCustInfoLayout.createSequentialGroup()
                .addGroup(pnlCustInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(pnlCustInfoLayout.createSequentialGroup()
                        .addGap(29, 29, 29)
                        .addComponent(lblCustName))
                    .addGroup(pnlCustInfoLayout.createSequentialGroup()
                        .addGap(37, 37, 37)
                        .addComponent(btnModifyCust)))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(lblCustEmail)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(lblCustPhone)
                .addContainerGap(80, Short.MAX_VALUE))
        );

        pnlGenInfo.add(pnlCustInfo);

        pnlRepairInfo.setBackground(new java.awt.Color(255, 255, 255));
        pnlRepairInfo.setFocusable(false);

        lblRepStatus.setFont(new java.awt.Font("PingFang HK", 1, 12)); // NOI18N
        lblRepStatus.setForeground(new java.awt.Color(0, 102, 255));
        lblRepStatus.setText("Statut de la réparation :");

        lblStartDateValue.setFont(new java.awt.Font("Calibri", 0, 14)); // NOI18N
        lblStartDateValue.setText("date");

        lblStartDate.setFont(new java.awt.Font("PingFang HK", 1, 12)); // NOI18N
        lblStartDate.setForeground(new java.awt.Color(0, 102, 255));
        lblStartDate.setText("Date d'entrée :");

        javax.swing.GroupLayout pnlRepairInfoLayout = new javax.swing.GroupLayout(pnlRepairInfo);
        pnlRepairInfo.setLayout(pnlRepairInfoLayout);
        pnlRepairInfoLayout.setHorizontalGroup(
            pnlRepairInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlRepairInfoLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnlRepairInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(lblRepStatus)
                    .addComponent(lblStartDate))
                .addGap(18, 18, 18)
                .addGroup(pnlRepairInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(cboStatus, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblStartDateValue))
                .addContainerGap(195, Short.MAX_VALUE))
        );
        pnlRepairInfoLayout.setVerticalGroup(
            pnlRepairInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlRepairInfoLayout.createSequentialGroup()
                .addGap(33, 33, 33)
                .addGroup(pnlRepairInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(cboStatus, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblRepStatus))
                .addGap(18, 18, 18)
                .addGroup(pnlRepairInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblStartDate)
                    .addComponent(lblStartDateValue))
                .addContainerGap(36, Short.MAX_VALUE))
        );

        pnlGenInfo.add(pnlRepairInfo);

        pnlMachineInfo.setBackground(new java.awt.Color(255, 255, 255));

        javax.swing.GroupLayout pnlMachineInfoLayout = new javax.swing.GroupLayout(pnlMachineInfo);
        pnlMachineInfo.setLayout(pnlMachineInfoLayout);
        pnlMachineInfoLayout.setHorizontalGroup(
            pnlMachineInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 383, Short.MAX_VALUE)
        );
        pnlMachineInfoLayout.setVerticalGroup(
            pnlMachineInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 125, Short.MAX_VALUE)
        );

        pnlGenInfo.add(pnlMachineInfo);

        add(pnlGenInfo);

        pnlDetails.setBackground(javax.swing.UIManager.getDefaults().getColor("Button.light"));
        pnlDetails.setForeground(new java.awt.Color(153, 153, 153));
        pnlDetails.setLayout(new java.awt.GridLayout(1, 0));

        pnlPartsCustomer.setBackground(javax.swing.UIManager.getDefaults().getColor("Button.light"));
        pnlPartsCustomer.setMaximumSize(new java.awt.Dimension(383, 500));
        pnlPartsCustomer.setMinimumSize(new java.awt.Dimension(383, 500));
        pnlPartsCustomer.setPreferredSize(new java.awt.Dimension(383, 500));
        pnlPartsCustomer.setLayout(new java.awt.BorderLayout());
        pnlDetails.add(pnlPartsCustomer);

        pnlNotesSct.setBackground(javax.swing.UIManager.getDefaults().getColor("Button.light"));
        pnlNotesSct.setAlignmentX(0.0F);
        pnlNotesSct.setAlignmentY(0.0F);
        pnlNotesSct.setPreferredSize(new java.awt.Dimension(383, 120));

        pnlNotesTitleBox.setBackground(new java.awt.Color(255, 255, 255));
        pnlNotesTitleBox.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(153, 153, 153)));

        lblNotes.setFont(new java.awt.Font("PingFang HK", 1, 18)); // NOI18N
        lblNotes.setText(" Notes");

        btnNewNote.setMnemonic('n');
        btnNewNote.setText("Nouvelle note");
        btnNewNote.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnNewNoteActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout pnlNotesTitleBoxLayout = new javax.swing.GroupLayout(pnlNotesTitleBox);
        pnlNotesTitleBox.setLayout(pnlNotesTitleBoxLayout);
        pnlNotesTitleBoxLayout.setHorizontalGroup(
            pnlNotesTitleBoxLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlNotesTitleBoxLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(lblNotes)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 186, Short.MAX_VALUE)
                .addComponent(btnNewNote)
                .addContainerGap())
        );
        pnlNotesTitleBoxLayout.setVerticalGroup(
            pnlNotesTitleBoxLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlNotesTitleBoxLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnlNotesTitleBoxLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(btnNewNote)
                    .addComponent(lblNotes))
                .addContainerGap())
        );

        scpNotes.setBackground(javax.swing.UIManager.getDefaults().getColor("Button.light"));
        scpNotes.setBorder(null);
        scpNotes.setHorizontalScrollBarPolicy(javax.swing.ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);
        scpNotes.setVerticalScrollBarPolicy(javax.swing.ScrollPaneConstants.VERTICAL_SCROLLBAR_ALWAYS);

        pnlNotes.setBackground(javax.swing.UIManager.getDefaults().getColor("Button.light"));
        pnlNotes.setAutoscrolls(true);
        pnlNotes.setLayout(new javax.swing.BoxLayout(pnlNotes, javax.swing.BoxLayout.PAGE_AXIS));
        scpNotes.setViewportView(pnlNotes);

        javax.swing.GroupLayout pnlNotesSctLayout = new javax.swing.GroupLayout(pnlNotesSct);
        pnlNotesSct.setLayout(pnlNotesSctLayout);
        pnlNotesSctLayout.setHorizontalGroup(
            pnlNotesSctLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlNotesSctLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnlNotesSctLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(pnlNotesTitleBox, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(scpNotes))
                .addContainerGap())
        );
        pnlNotesSctLayout.setVerticalGroup(
            pnlNotesSctLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlNotesSctLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(pnlNotesTitleBox, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(scpNotes, javax.swing.GroupLayout.DEFAULT_SIZE, 598, Short.MAX_VALUE)
                .addContainerGap())
        );

        pnlDetails.add(pnlNotesSct);

        pnlExtraInfo.setBackground(javax.swing.UIManager.getDefaults().getColor("Button.light"));
        pnlExtraInfo.setPreferredSize(new java.awt.Dimension(383, 120));

        btnSave.setText("Enregistrer les modifications");

        btnCancel.setText("Annuler");

        javax.swing.GroupLayout pnlExtraInfoLayout = new javax.swing.GroupLayout(pnlExtraInfo);
        pnlExtraInfo.setLayout(pnlExtraInfoLayout);
        pnlExtraInfoLayout.setHorizontalGroup(
            pnlExtraInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pnlExtraInfoLayout.createSequentialGroup()
                .addContainerGap(131, Short.MAX_VALUE)
                .addComponent(btnCancel)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(btnSave)
                .addContainerGap())
        );
        pnlExtraInfoLayout.setVerticalGroup(
            pnlExtraInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pnlExtraInfoLayout.createSequentialGroup()
                .addContainerGap(640, Short.MAX_VALUE)
                .addGroup(pnlExtraInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnSave)
                    .addComponent(btnCancel))
                .addContainerGap())
        );

        pnlDetails.add(pnlExtraInfo);

        add(pnlDetails);
    }// </editor-fold>//GEN-END:initComponents

    /* Affiche le panel de saise de mise à jour des notes de réparation */
    private void btnNewNoteActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnNewNoteActionPerformed
        PnlUpdateCaseNotes p = new PnlUpdateCaseNotes(this);
        pnlNotes.add(p, 0);
        scpNotes.setViewportView(pnlNotes);
        btnNewNote.setVisible(false);
        p.setTitleFocused();
    }//GEN-LAST:event_btnNewNoteActionPerformed

    /* Permet de réafficher le panel de saisie de  données utilisateur et 
     * de cacher le bouton de modification des données utilisateur 
     */
    private void btnModifyCustActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnModifyCustActionPerformed
        p2.getPnlNewCust().setVisible(true);
        p2.getPnlNewCust().setEnabled(true);
        btnModifyCust.setEnabled(false);
        btnModifyCust.setVisible(false);
    }//GEN-LAST:event_btnModifyCustActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnCancel;
    private javax.swing.JButton btnModifyCust;
    private javax.swing.JButton btnNewNote;
    private javax.swing.JButton btnSave;
    private javax.swing.JComboBox<String> cboStatus;
    private javax.swing.JLabel lblCustEmail;
    private javax.swing.JLabel lblCustName;
    private javax.swing.JLabel lblCustPhone;
    private javax.swing.JLabel lblNotes;
    private javax.swing.JLabel lblRepStatus;
    private javax.swing.JLabel lblStartDate;
    private javax.swing.JLabel lblStartDateValue;
    private javax.swing.JPanel pnlCustInfo;
    private javax.swing.JPanel pnlDetails;
    private javax.swing.JPanel pnlExtraInfo;
    private javax.swing.JPanel pnlGenInfo;
    private javax.swing.JPanel pnlMachineInfo;
    private javax.swing.JPanel pnlNotes;
    private javax.swing.JPanel pnlNotesSct;
    private javax.swing.JPanel pnlNotesTitleBox;
    private javax.swing.JPanel pnlPartsCustomer;
    private javax.swing.JPanel pnlRepairInfo;
    private javax.swing.JScrollPane scpNotes;
    // End of variables declaration//GEN-END:variables

    /* Vérifie si le statut de réparation correspond a une nouvelle réparation 
     * ou à une réparation éxistante et affiche le panel adapté 
     */
    private void checkRepStatus(boolean isNewRep) {
        if (isNewRep) {
            btnNewNote.setVisible(false);
            PnlNewCaseNotes p1 = new PnlNewCaseNotes(this);
            pnlNotes.add(p1);
            p2 = new PnlNewPartsSelection(this, p1);
            p1.setUserInfo(p2);
            customerComponents = p2.getCustomerComponents();
            pnlPartsCustomer.add(p2);
            parent.setFocusTraversalPolicy(new MyFocusTraversalPolicy(customerComponents));
            cboStatus.setEnabled(false);
            cboStatus.setVisible(false);
            lblRepStatus.setVisible(false);
            lblStartDate.setVisible(false);
            lblStartDateValue.setVisible(false);
        } else {
            btnNewNote.setVisible(true);
            p1 = new PnlPartsUsedSelection(repNo);
            pnlPartsCustomer.add(p1);
        }
    }

    /* Affiche les données client dans l'entête */
    protected void displayCustomer(Customer c) {
        lblCustName.setText(c.getFirstname() + " " + c.getLastname());
        lblCustEmail.setText(c.getEmail());
        lblCustPhone.setText(c.getPhone());
        customerAdress = c.getAddress();
        customerArea = c.getArea();
        customerNpa = c.getNpa();
    }

    /* Affiche une note enregistrée (à développer) */
    protected void displayPermaNote() throws BadLocationException {
        for (int i = 0; i < lstNotes.size(); i++) {
            p3 = new PnlPermaNote();
            p3.setPermaNote((Note) lstNotes.get(i));
            pnlNotes.add(p3, 0);
        }
        scpNotes.setViewportView(pnlNotes);
    }

    //Affiche les notes qui ont déjà été enregistrées
    protected void displayPermaNote(Note n) throws BadLocationException {
        p3 = new PnlPermaNote();
        p3.setPermaNote(n);
        pnlNotes.add(p3, 0);
        scpNotes.setViewportView(pnlNotes);
    }

    protected JButton getBtnModifyCust() {
        return btnModifyCust;
    }

    protected boolean getRepStatus() {
        return isNewRep;
    }

    void loadUsedParts(int repairNo) {
        p1 = new PnlPartsUsedSelection();
        p1.loadUsedParts(repairNo);

    }

    void displayBeginDate(Date d) {
        lblStartDateValue.setText(sdf.format(d));
    }

    void displayStatus(int status) {
        loadStatusList();
        for (int i = 0; i < statusList.size(); i++) {
            cboStatus.addItem(statusList.get(i).toString());
        }
        cboStatus.setSelectedIndex(status);
    }

    protected void loadNotes(int repId) {
        try {
            lstNotes = new ArrayList<Note>(RepairDao.getNotes(repId));
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    protected void setBtnNewAsVisible() {
        btnNewNote.setVisible(true);
    }

    private void loadStatusList() {
        try {
            statusList = base.RepairDao.getStatusList();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    protected String getCustomerInfo() {
        return lblCustName.getText() + "\n" + lblCustPhone.getText() + "\n" + customerAdress + "\n" + customerNpa + ", " + customerArea;
    }
    
    protected ArrayList getNotes() {
        return lstNotes;
    }
    
    protected int getRepairNo() {
        return repNo;
    }

}
